<style>
    .vtabs .tabs-vertical {
        width: 250px;
    }

    .full-width-btn {
        width: 100%;
        margin: 5px 0;
    }

    .padding0 {
        padding: 0;
    }

    .customer-name {
        margin-top: 15px;
    }

    .maxHeigh135 {
        height: 135px;
    }

    .small-font h1 {
        font-size: 26px !important;
    }

    .error {
        color: red;
    }

</style>
{{#if error}}
    <div id="error" class="alert alert-danger" style="margin-top: 25px;">{{errMessage}}</div>
{{/if}}
<div class="row page-titles">
    <div class="col-md-5 align-self-center">
        <h4 class="text-themecolor">Conozca su cliente (Know your Customer)</h4>
    </div>
    <div class="col-md-7 align-self-center text-right">
        <div class="d-flex justify-content-end align-items-center">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">KYC Garantias:</li>
            </ol>

        </div>
    </div>
</div>

<div class="row">
    <!-- Column -->
    <div class="col-lg-3 col-xlg-2 col-md-4">
        <div class="card"><img class="card-img" src="/img/bg1.jpg" height="280" alt="Card image">
            <div class="card-img-overlay card-inverse text-white social-profile d-flex justify-content-center">
                <div class="align-self-center"><img src="/img/profile-placeholder.png" class="img-circle" width="100">
                    <h4 class="card-title customer-name">{{customer.nombre}}</h4>
                </div>
            </div>
        </div>
        {{#if permissions.kyc.hasCreate}}
            <div class="col-lg-12 col-xlg-12 col-md-12 padding0">
                <button type="button" class="btn waves-effect waves-light btn-outline-secondary full-width-btn"
                        id="assign">
                    Asignarme este proceso
                </button>
                <button type="button" class="btn waves-effect waves-light btn-warning full-width-btn" id="moreInfoBtn">
                    Solicitar mas Información
                </button>
                <button type="button" class="btn waves-effect waves-light btn-info full-width-btn" id="aprobar">
                    Aprobar
                </button>
                {{#if showPDFBtn}}
                    <button type="button" class="btn waves-effect waves-light btn-outline-secondary full-width-btn"
                            id="pdf">Descargar PDF
                    </button>
                {{/if}}
                <button type="button" class="btn waves-effect waves-light btn-danger full-width-btn" id="reject">
                    Rechazar
                </button>
            </div>
        {{/if}}
    </div>
    <!-- Column -->
    <!-- Column -->

    <div class="col-lg-9 col-xlg-10 col-md-8">
        <div class="row">
            <!-- Column -->
            {{#if hasNoOwner}}
                <div class="col-lg-12 col-md-12">
                    <div class="alert alert-danger"> Este cliente no tiene ningun asesor asignado.
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                    </div>
                </div>
            {{/if}}
            {{#if hasNoEmail}}
                <div class="col-lg-12 col-md-12">
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                        <h3 class="text-warning"><i class="fa fa-exclamation-triangle"></i> Precaución</h3> Este cliente
                        no tiene ningun correo electrónico asociado, es un nivel de riesgo alto.
                    </div>
                </div>
            {{/if}}
            {{#if_eq info.status 'approved'}}
                <div class="col-lg-12 col-md-12">
                    <div class="alert alert-info">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                        <h3 class="text-info"><i class="fa fa-exclamation-circle"></i> Importante</h3> Este cliente esta
                        en espera de revisión por parte de un supervisor.
                    </div>
                </div>
            {{/if_eq}}
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body maxHeigh135">
                        <div class="row p-t-10 p-b-10">
                            <!-- Column -->
                            <div class="col p-r-0">
                                <h1 class="font-light">N/D</h1>
                                <h6 class="text-muted">Nivel de Riesgo</h6></div>
                            <!-- Column -->
                            <div class="col text-right align-self-center">
                                <div data-label="20%" class="css-bar m-b-0 css-bar-primary css-bar-20"><i
                                        class="mdi mdi-account-circle"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Column -->
            <!-- Column -->
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body maxHeigh135">
                        <div class="row p-t-10 p-b-10">
                            <!-- Column -->
                            <div class="col p-r-0">
                                <h1 class="font-light">{{views}}</h1>
                                <h6 class="text-muted">Visualizaciones</h6></div>
                            <!-- Column -->
                            <div class="col text-right align-self-center">
                                <div data-label="30%" class="css-bar m-b-0 css-bar-danger css-bar-20"><i
                                        class="mdi mdi-briefcase-check"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Column -->
            <!-- Column -->
            <div class="col-lg-3 col-md-6">
                <div class="card">
                    <div class="card-body maxHeigh135">
                        <div class="row p-t-10 p-b-10">
                            <!-- Column -->
                            <div class="col p-r-0">
                                <h1 class="font-light">N/D</h1>
                                <h6 class="text-muted">Tiempo en el formulario</h6></div>
                            <!-- Column -->
                            <div class="col text-right align-self-center">
                                <div data-label="40%" class="css-bar m-b-0 css-bar-warning css-bar-40"><i
                                        class="mdi mdi-star-circle"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Column -->
            <!-- Column -->
            <div class="col-lg-3 col-md-6">
                <div class="card text-white {{parseStatusColor customer.status}}">
                    <div class="card-body maxHeigh135">
                        <div class="row p-t-10 p-b-10">
                            <!-- Column -->
                            <div class="col p-r-0">
                                <h1 class="font-light">{{parseStatus customer.status}}</h1>
                                <h6 class=" text-white">Estado</h6></div>
                            <!-- Column -->

                        </div>
                    </div>
                </div>
            </div>
            <!-- Column -->
        </div>

        <div class="card">
            <!-- Nav tabs -->
            <div class="vtabs customvtab">
                {{#each customerInfo}}
                    <div class="card-header bg-info">
                        <h4 class="m-b-0 text-white">{{block.name}}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {{#each block.fields}}
                                {{{drawInput label initialValue type isSelected desktopSize helper}}}
                            {{/each}}
                        </div>
                    </div>
                {{else}}
                    Error retrieving customerInfo, please contact an Hubex Admin
                {{/each}}
                <div class="card-header bg-info">
                    <h4 class="m-b-0 text-white">Información exclusiva de Banco Cathay</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="poseeLineaDeCredito">Posee línea de crédito</label>
                            <select class="form-control" id="poseeLineaDeCredito" {{#if_eq user.usertype 'formalizationofficer'}} disabled="disabled" {{/if_eq}}>
                                <option>Si</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="cumpleConLosRequisitos">Cumple con los requisitos</label>
                            <select class="form-control" id="cumpleConLosRequisitos" {{#if_eq user.usertype 'formalizationofficer'}} disabled="disabled" {{/if_eq}}>
                                <option>Si</option>
                                <option>No</option>
                            </select>
                        </div>
                        {{#if_eq user.usertype 'headofcredit'}}
                            <div class="form-group col-md-4">
                                <label for="cumpleConLosRequisitos">Operaciones al día</label>
                                <select class="form-control" id="cumpleConLosRequisitos" {{#if_eq user.usertype 'formalizationofficer'}} disabled="disabled" {{/if_eq}}>
                                    <option>Si</option>
                                    <option>No</option>
                                </select>
                            </div>
                        {{/if_eq}}
                        <div class="form-group col-md-4">
                            <label for="percentageDeComision">% de Comisión</label>
                            <input type="number" max="100" min="0" class="form-control" id="percentageDeComision"
                                   placeholder="% de Comisión" value="" {{#if_eq user.usertype 'formalizationofficer'}} readonly="" {{/if_eq}}>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="Vencimiento">Vencimiento</label>
                            <input type="text" class="form-control" id="Vencimiento" placeholder="dd-mm-yyyy" value="" {{#if_eq user.usertype 'formalizationofficer'}} readonly="" {{/if_eq}}>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="montoDeComisioin">Monto de Comisión</label>
                            <input type="number" max="100" min="0" class="form-control" id="montoDeComisioin"
                                   placeholder="Monto de Comisión" value="" {{#if_eq user.usertype 'formalizationofficer'}} readonly="" {{/if_eq}}>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="poseeLineaDeCredito">Formalizador</label>
                            <select class="form-control" id="formalizador" {{#if_eq user.usertype 'formalizationofficer'}} disabled="disabled" {{/if_eq}}>
                                <option>Select Analyst</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="poseeLineaDeCredito">Revisor</label>
                            <select class="form-control" id="revisor" {{#if_eq user.usertype 'formalizationofficer'}} disabled="disabled" {{/if_eq}}>
                                <option>Select Analyst</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Column -->
</div>
<div class="modal fade" id="more-Info" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel1"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel1">Solicitar mas información</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- <div class="form-group">
                        <label for="recipient-name" class="control-label">Razón del rechazo:</label>
                        <input type="text" class="form-control" id="recipient-name1">
                    </div> -->
                    {{!-- <div class="form-group">
                        <label for="message-text" class="control-label">Destinatario:</label>
                        <input class="form-control" id="message-header" type="text" />
                    </div> --}}
                    <div class="form-group">
                        <!-- <label for="message-text" class="control-label">:</label> -->
                        <textarea class="form-control" id="message-text" rows="10"></textarea>
                    </div>
                    <div id="msg-footer"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" id="saveRequestDetails" class="btn btn-primary">Enviar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="reject-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel1"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel1">Rechazar Aprobación</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
                <form>
                    {{!-- <div class="form-group">
                        <label for="recipient-name" class="control-label">Razón del rechazo:</label>
                        <input type="text" class="form-control" id="recipient-name1">
                    </div> --}}
<!--                    <div class="form-group">-->
<!--                        <label for="" class="control-label">Asignar Agente:</label>-->
<!--                        <select class="form-control select2-dropdown" id="agent" style="width:100%">-->
<!--                            {{#each userlist}}-->
<!--                                <option value="{{id}}">{{name}} {{lastname}}</option>-->
<!--                            {{/each}}-->
<!--                        </select>-->
<!--                    </div>-->
                    <div class="form-group">
                        <label for="message-text" class="control-label">Razón del Rechazo</label>
                        <textarea class="form-control" id="message-text-reject" rows="10"></textarea>
                    </div>
                    <div id="msg-footer"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" id="saveRejectDetails" class="btn btn-primary">Rechazar</button>
            </div>
        </div>
    </div>
</div>
<script>
    $('.js-switch').each(function () {
        new Switchery($(this)[0], $(this).data());
    });

    function saveOwner() {
        var url = "/kycGarantias/{{org}}/{{currentProject}}/setOwner";
        var data = {
            identityToken: "{{identityToken}}",
            owner: "{{user.id}}"
        }
        $.ajax({
            method: "post",
            url: url,
            data: data,
            success: function (data) {
                console.log('data', data)
                if (data.success === true) {
                    toastr.success('Agente Asignado con Éxito', function () {
                        setTimeout(function () {
                            window.location.reload()
                        }, 1000);
                    });
                } else {
                    toastr.error(data.message);

                }
            },
            error: function (data) {
                toastr.error('Technical Error');
                //$(this).prop('disabled', false);
            }
        })
                .done(function () {
                    //$(this).prop('disabled', false);
                })
                .fail(function () {
                    toastr.error('Request Failed');
                    //$(this).prop('disabled', false);
                })
    }

    $(document).ready(function () {
        var dateFormat = "dd-mm-yy",
                from = $("#percentageDeComision")
                        .datepicker({
                            defaultDate: "+1w",
                            changeMonth: true,
                            dateFormat: dateFormat
                        })
                        .on("change", function () {
                            var toMinDate = getDate(this);
                            toMinDate.setDate(toMinDate.getDate() + 1);
                            to.datepicker("option", "minDate", toMinDate);
                        })

        $('#moreInfoBtn').on('click', function (e) {
            e.preventDefault();
            if ({{hasNoEmail}}) {
                Swal.fire({
                    title: "Este cliente no tiene correo electrónico",
                    text: "Comunicarse directamente al teléfono: {{customer.telefono}}",
                    icon: 'warning',
                    showCancelButton: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#e46a76',
                    confirmButtonText: 'Aceptar',
                    cancelButtonText: 'No!'
                }).then(function (result) {
                    if (result.value) {

                    }
                })
            } else {
                $('#more-Info').modal('show');
            }


        })

        $(".select2-dropdown").select2({
            placeholder: "Seleccione un agente"
        });

        $('body').on('click', '#assign', function (e) {
            e.preventDefault();
            if ({{hasNoOwner}}) {
                saveOwner()
            } else {

                Swal.fire({
                    title: "Este cliente tiene un agente asignado",
                    text: "Desea asignarse este cliente?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#e46a76',
                    confirmButtonText: 'Si!',
                    cancelButtonText: 'No!'
                }).then(function (result) {
                    if (result.value) {
                        saveOwner()
                    }
                })
            }


        });
        $('body').on('click', '#aprobar', function (e) {
            e.preventDefault();

            Swal.fire({
                title: "Desea aprobar este proceso?",
                text: "Al aprobar este proceso automaticamente sera asignado a su supervisor",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#e46a76',
                confirmButtonText: 'Si!',
                cancelButtonText: 'No'
            }).then(function (result) {
                if (result.value) {
                    var url = "/kycGarantias/{{org}}/{{currentProject}}/setApproved";
                    var data = {
                        identityToken: "{{identityToken}}"
                    }
                    $.ajax({
                        method: "post",
                        url: url,
                        data: data,
                        success: function (data) {
                            console.log('data', data)
                            if (data.success === true) {
                                toastr.success('Proceso Aprobado', function () {
                                    setTimeout(function () {
                                        window.location.reload()
                                    }, 1000);
                                });
                            } else {
                                toastr.error(data.message);

                            }
                        },
                        error: function (data) {
                            toastr.error('Technical Error');
                            //$(this).prop('disabled', false);
                        }
                    })
                            .done(function () {
                                //$(this).prop('disabled', false);
                            })
                            .fail(function () {
                                toastr.error('Request Failed');
                                //$(this).prop('disabled', false);
                            })
                }
            })

        });

        $('body').on('click', '#done', function (e) {
            e.preventDefault();

            Swal.fire({
                title: "Desea aprobar este proceso?",
                text: "Al aprobar este proceso se cambiara su estado a Completado",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#e46a76',
                confirmButtonText: 'Si!',
                cancelButtonText: 'No'
            }).then(function (result) {
                if (result.value) {
                    var url = "/kycGarantias/{{org}}/{{currentProject}}/setDone";
                    var data = {
                        identityToken: "{{identityToken}}"
                    }
                    $.ajax({
                        method: "post",
                        url: url,
                        data: data,
                        success: function (data) {
                            console.log('data', data)
                            if (data.success === true) {
                                toastr.success('Proceso Completado', function () {
                                    setTimeout(function () {
                                        window.location.reload()
                                    }, 1000);
                                });
                            } else {
                                toastr.error(data.message);

                            }
                        },
                        error: function (data) {
                            toastr.error('Technical Error');
                            //$(this).prop('disabled', false);
                        }
                    })
                            .done(function () {
                                //$(this).prop('disabled', false);
                            })
                            .fail(function () {
                                toastr.error('Request Failed');
                                //$(this).prop('disabled', false);
                            })
                }
            })

        });

        $('body').on('click', '#saveRequestDetails', function (e) {
            e.preventDefault();

            if ($('#message-text').val().length <= 0) {

                $('#message-text').after('<div class="error">Este campo es requerido</div>')

                return false;

            }

            var url = "/kycGarantias/{{org}}/{{currentProject}}/requestMoreInfo";
            var data = {
                identityToken: "{{identityToken}}",
                message: $('#message-text').val()
            }

            Swal.fire({
                title: "Confirmar esta acción",
                text: "Desea enviarle este mensaje a el cliente",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#e46a76',
                confirmButtonText: 'Si!',
                cancelButtonText: 'No'
            }).then(function (result) {
                if (result.value) {
                    $.ajax({
                        method: "post",
                        url: url,
                        data: data,
                        success: function (data) {
                            console.log('data', data)
                            $('#more-Info').modal('hide');
                            toastr.success('Mensaje Enviado', function () {
                                setTimeout(function () {
                                    window.location.reload()
                                }, 1000);
                            });
                        },
                        error: function (data) {
                            toastr.error('Technical Error');
                            //$(this).prop('disabled', false);
                        }
                    })
                            .done(function () {
                                //$(this).prop('disabled', false);
                            })
                            .fail(function () {
                                toastr.error('Request Failed');
                                //$(this).prop('disabled', false);
                            })
                }
            })

        });


        $('body').on('click', '#saveRejectDetails', function (e) {
            e.preventDefault();

            if ($('#message-text-reject').val().length <= 0) {

                $('#message-text-reject').after('<div class="error">Este campo es requerido</div>')

                return false;

            }

            var url = "/kycGarantias/{{org}}/{{currentProject}}/setRejects";
            var data = {
                identityToken: "{{identityToken}}",
                message: $('#message-text-reject').val()
            }
            console.log('dat', data)


            Swal.fire({
                title: "Confirmar esta acción",
                text: "Desear Rechazar esta solicitud?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#e46a76',
                confirmButtonText: 'Si!',
                cancelButtonText: 'No'
            }).then(function (result) {
                if (result.value) {
                    $.ajax({
                        method: "post",
                        url: url,
                        data: data,
                        success: function (data) {
                            console.log('data', data)
                            $('#reject-modal').modal('hide');
                            toastr.success('Se ha rechazado esta solicitud', function () {
                                setTimeout(function () {
                                    window.location.reload()
                                }, 1000);
                            });
                        },
                        error: function (data) {
                            toastr.error('Technical Error');
                            //$(this).prop('disabled', false);
                        }
                    })
                            .done(function () {
                                //$(this).prop('disabled', false);
                            })
                            .fail(function () {
                                toastr.error('Request Failed');
                                //$(this).prop('disabled', false);
                            })
                }
            })

        });

        $('#reject').on('click', function (e) {
            e.preventDefault();
            $('#reject-modal').modal('show');
        });


        $('body').on('click', '#pdf', function (e) {
            e.preventDefault();
            var org = $.trim("{{org}}")
            var caris = "{{identityToken}}";
            console.log('caris', caris)
            var current = window.location.href
            var arr = current.split("/");
            var result = arr[0] + "//" + arr[2]
            var url = "kycGarantias/" + org + "/{{currentProject}}/getPdfInfo/{{identityToken}}";
            var _url = result + '/' + url;
            console.log('_url', url)
            window.open(_url, '_blank');


        });
        //TODO test this ajax against the setCustomerInformation api URL
        $("#btnEditCustomerInfo").click(function () {
            $.ajax({
                method: "post",
                url: "/kycGarantias/update",
                data: {
                    customerId: "{{customer._id}}",
                    name: $("#name").val(),
                    lastname: $("#lastname").val(),
                    secondlastname: $("#secondlastname").val(),
                    email: $("#email").val(),
                    address: $("#address").val(),
                },
                success: function (data) {
                    if (data.success === true) {
                        toastr.success(data.message, function () {
                            setTimeout(function () {
                                window.location.href = '/dashboard/projects';
                            }, 2000);
                        });
                    } else {
                        toastr.error(data.message);
                    }
                },
                error: function (data) {
                    toastr.error('Technical Error');
                }
            });
        });
    });

</script>
